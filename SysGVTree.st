
Object subclass: #SysGVTree
    instanceVariableNames: 'relations definitions outFileName outStr dotFileName '
    classVariableNames: ''
    poolDictionaries: 'PlatformConstants PlatformFunctions '!

!SysGVTree class publicMethods !

new
	^super new initialize! !

!SysGVTree class privateMethods !

_PRAGMA_IS_

	"%%PRAGMA DECLARE
	(name: IS_SysGVTree isPool: true isConstant: false)
	(pool: IS_SysGVTree declarations: (
		(name: IS_dotFileName isConstant: false)
		(name: IS_makeTreeFull_ isConstant: false)
		(name: IS_outFileName isConstant: false)
		(name: IS_makeTree_ isConstant: false)
		(name: IS_instanceInterfaceSpec isConstant: false)
	))"!

abtPrimFlushInterfaceSpecCache

	IS_SysGVTree associationsDo: [: poolDictionaryAssoc | poolDictionaryAssoc value: nil].
	super abtPrimFlushInterfaceSpecCache!

IS_dotFileName
	"Private - ** Warning ** This method is generated by VisualAge and should not
	be modified or deleted. This method is responsible for returning a featureSpec
	that describes the implementation of a particular feature of the receiver"

	^IS_SysGVTree::IS_dotFileName notNil
		ifTrue: [IS_SysGVTree::IS_dotFileName]
		ifFalse: [
		IS_SysGVTree::IS_dotFileName := (AbtAttributeSpec new
		 attributeType: String;
		 setSelector: #dotFileName:;
		 getSelector: #dotFileName;
		 changeSymbol: #dotFileName)]!

IS_instanceInterfaceSpec
	"Private - ** Warning ** This method is generated by VisualAge and should not
	be modified or deleted. This method is responsible for returning a featureSpec
	that describes the implementation of a particular feature of the receiver"

	^IS_SysGVTree::IS_instanceInterfaceSpec notNil
		ifTrue: [IS_SysGVTree::IS_instanceInterfaceSpec]
		ifFalse: [
		IS_SysGVTree::IS_instanceInterfaceSpec := AbtInterfaceSpec new
		featureNamed: #dotFileName put: self IS_dotFileName;
		featureNamed: #makeTreeFull: put: self IS_makeTreeFull_;
		featureNamed: #outFileName put: self IS_outFileName;
		featureNamed: #makeTree: put: self IS_makeTree_]!

IS_makeTree_
	"Private - ** Warning ** This method is generated by VisualAge and should not
	be modified or deleted. This method is responsible for returning a featureSpec
	that describes the implementation of a particular feature of the receiver"

	^IS_SysGVTree::IS_makeTree_ notNil
		ifTrue: [IS_SysGVTree::IS_makeTree_]
		ifFalse: [
		IS_SysGVTree::IS_makeTree_ := (AbtActionSpec new
		 parameters: (OrderedCollection new
			 add: (AbtParameterSpec new parameterType: Collection; parameterName: 'col');
			 yourself);
		 selector: #makeTree:)]!

IS_makeTreeFull_
	"Private - ** Warning ** This method is generated by VisualAge and should not
	be modified or deleted. This method is responsible for returning a featureSpec
	that describes the implementation of a particular feature of the receiver"

	^IS_SysGVTree::IS_makeTreeFull_ notNil
		ifTrue: [IS_SysGVTree::IS_makeTreeFull_]
		ifFalse: [
		IS_SysGVTree::IS_makeTreeFull_ := (AbtActionSpec new
		 parameters: (OrderedCollection new
			 add: (AbtParameterSpec new parameterType: Collection; parameterName: 'col');
			 yourself);
		 selector: #makeTreeFull:)]!

IS_outFileName
	"Private - ** Warning ** This method is generated by VisualAge and should not
	be modified or deleted. This method is responsible for returning a featureSpec
	that describes the implementation of a particular feature of the receiver"

	^IS_SysGVTree::IS_outFileName notNil
		ifTrue: [IS_SysGVTree::IS_outFileName]
		ifFalse: [
		IS_SysGVTree::IS_outFileName := (AbtAttributeSpec new
		 attributeType: String;
		 setSelector: #outFileName:;
		 getSelector: #outFileName;
		 changeSymbol: #outFileName)]! !

!SysGVTree publicMethods !

addToOut: str

	outStr isNil
	ifTrue: [
		outStr := String new.
	].

	outStr := outStr, str, '' crStr.
	!

deeper: class
	class isNil
	ifTrue: [ ^nil ].

	class subclasses do: [:e |
		definitions add: (e asString).
		relations add: (e asString), ' -> ', (class asString).
		self deeper: e.
	].		
!

dotFileName
	" Filename of graphviz source. "

	^dotFileName ifNil: [ dotFileName := 'out.gv' ]!

dotFileName: aString
	" Filename of graphviz source. "

	dotFileName := aString.
	self signalEvent: #dotFileName
		 with: aString.!

generateGVTreeText
	" Generate source in DOT language for graph. "
	| fsOut |
	self addToOut: 'digraph graphname {'.
	definitions do: [ :e |
		self addToOut: '	', e.
	].
	self addToOut: ''.
	relations do: [ :e |
		self addToOut: '	', e.
	].
	self addToOut: '}'.

	fsOut := CfsWriteFileStream openEmpty: (self dotFileName).
	fsOut nextPutAll: outStr.
	fsOut flush.
	fsOut close.
	fsOut := nil.
	
	self renderGVTree.
!

initialize
	outStr := String new.
	definitions := Set new.
	relations := Set new.
!

makeTree: col
" Make tree with chain of superclasses of classes from input collection. "
	col isEmpty
	ifTrue: [ ^nil ].

	col do: [ :class |
		self upper: class.
	].

	self generateGVTreeText.
!

makeTreeComplete: col
" Make tree with all subclasses and superclasses of classes from input collection. "
	col isEmpty
	ifTrue: [ ^nil ].

	col do: [ :class |
		self upper: class.
	].

	col do: [ :class |
		self deeper: class.
	].

	self generateGVTreeText!

makeTreeFull: col
" Make tree with all subclasses of classes from input collection. "

	col isEmpty
	ifTrue: [ ^nil ].

	col do: [ :class |
		self deeper: class.
	].

	self generateGVTreeText!

openGVTree
" Open diagram image in external image viewer. "
	OSHwnd new
		  shellExecute: nil
		  lpFile: (self outFileName)
		  lpParameters: nil
		  lpDirectory: nil
		  nShowCmd: SwNormal.
	!

outFileName
	" Filename of diagram image. "

	^outFileName ifNil: [ dotFileName := 'out.png' ]!

outFileName: aString
	" Filename of diagram image. "

	outFileName := aString.
	self signalEvent: #outFileName
		 with: aString.!

renderGVTree
" Render source to diagram image with graphviz. "
	OSHwnd new
		  shellExecute: nil
		  lpFile: 'dot.exe'
		  lpParameters: ('-Tpng -Kdot  -o', (self outFileName), ' ',(self dotFileName))
		  lpDirectory: nil
		  nShowCmd: SwNormal.
	(Delay forSeconds: 1) wait.
!

upper: class
	class isNil
	ifTrue: [ ^nil ].

	definitions add: ('	', (class asString)).
	
	class superclass notNil
	ifTrue: [ | str |
		relations add: (class asString), ' -> ', (class superclass asString).
		self upper: (class superclass).
	].! !

SysGVTree initializeAfterLoad!
